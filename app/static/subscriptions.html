<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Подписки — картотека</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
        }
        .layout {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 120px;
            background: #e3eafc;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            padding: 20px 0;
            border-right: 2px solid #b6c6e3;
        }
        .sidebar-btn {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            margin: 10px 0;
            padding: 12px 8px;
            border: none;
            border-radius: 8px 8px 0 0;
            background: #fff;
            color: #333;
            font-weight: bold;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .sidebar-btn.active, .sidebar-btn:hover {
            background: #b6c6e3;
            color: #007bff;
        }
        .main-content {
            flex: 1;
            background: #d6f0ff;
            padding: 30px 40px;
            display: flex;
            flex-direction: column;
        }
        .main-content h2 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 30px;
        }
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 30px;
            justify-items: center;
        }
        .subscription-card {
            width: 160px;
            height: 200px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 3px solid #000;
            transition: border 0.2s, box-shadow 0.2s, background 0.2s;
            position: relative;
        }
        .subscription-card.status-progress {
            background: #fffbe6;
            border-color: #ffc107;
        }
        .subscription-card.status-ready {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        .subscription-card.status-completed {
            background: #e6ffed;
            border-color: #28a745;
        }
        .subscription-card.status-other {
            background: #f5f5f5;
            border-color: #b6c6e3;
        }
        .subscription-card.frequency-month {
            background: #007bff;
            color: white;
        }
        .subscription-card.frequency-year {
            background: #e6e6fa;
            color: #333;
        }
        .subscription-card .icon {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
        }
        /* Стили для иконок в зависимости от частоты */
        .subscription-card.frequency-month .icon {
            filter: brightness(0) invert(1);
        }
        .subscription-card.frequency-year .icon {
            filter: none;
        }
        .subscription-card .name {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 8px;
            text-align: center;
        }
        .subscription-card .amount {
            font-size: 1.2em;
            font-weight: bold;
        }
        /* Специальные стили для текста в зависимости от частоты */
        .subscription-card.frequency-month .name,
        .subscription-card.frequency-month .amount {
            color: white;
        }
        .subscription-card.frequency-year .name,
        .subscription-card.frequency-year .amount {
            color: #333;
        }
        /* Модалка */
        .modal-bg {
            display: none;
            position: fixed;
            left: 0; top: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-bg.active {
            display: flex;
        }
        .modal {
            background: #fff;
            border-radius: 12px;
            padding: 30px 30px 20px 30px;
            min-width: 320px;
            max-width: 90vw;
            box-shadow: 0 4px 24px rgba(0,0,0,0.18);
            position: relative;
        }
        .modal .close {
            position: absolute;
            right: 18px;
            top: 12px;
            font-size: 1.5em;
            color: #888;
            cursor: pointer;
        }
        /* Стили для редактирования */
        .modal-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .modal-field {
            margin-bottom: 15px;
        }
        .modal-field label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        .modal-field input, .modal-field select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .modal-field input:focus, .modal-field select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        .readonly {
            background: #f8f9fa;
            color: #6c757d;
        }
        /* Цвета для фильтров в сайдбаре */
        .sidebar-btn.all { background: #e3eafc; color: #333; }
        .sidebar-btn.to-pay { background: #fffde7; color: #ff9800; }
        .sidebar-btn.completed { background: #e6ffed; color: #28a745; }
        .sidebar-btn.archived { background: #f5f5f5; color: #6c757d; }
        .sidebar-btn.active {
            border-left: 6px solid #007bff;
            filter: brightness(0.95);
        }
        .card-check-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #e6ffed;
            border: 2px solid #28a745;
            color: #28a745;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 1.2em;
            cursor: pointer;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .card-check-btn:hover {
            background: #28a745;
            color: #fff;
        }
        .card-ready-btn {
            position: absolute;
            top: 8px;
            right: 40px;
            background: #e3f2fd;
            border: 2px solid #2196f3;
            color: #2196f3;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 1.2em;
            cursor: pointer;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .card-ready-btn:hover {
            background: #2196f3;
            color: #fff;
        }
        .subscription-card.status-completed .card-check-btn,
        .subscription-card.status-completed .card-ready-btn {
            display: none;
        }
        .subscription-card.status-ready .card-ready-btn {
            display: none;
        }
        .subscription-card {
            position: relative;
        }
        /* Стили для фильтра по месяцам */
        .month-filter {
            margin: 20px 0;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }
        .month-filter.active {
            display: block;
        }
        .month-filter h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.1em;
        }
        .month-filter select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-right: 10px;
        }
        .month-filter button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .month-filter button:hover {
            background: #0056b3;
        }
        /* Стили для отображения дат */
        .date-info {
            font-size: 0.8em;
            color: #666;
            margin-top: 4px;
            text-align: center;
        }
        .date-info .billing {
            color: #dc3545;
        }
        .date-info .replenishment {
            color: #28a745;
        }
        /* Специальные стили для date-info в зависимости от частоты */
        .subscription-card.frequency-month .date-info .billing {
            color: rgba(255, 255, 255, 0.9);
        }
        .subscription-card.frequency-month .date-info .replenishment {
            color: rgba(255, 255, 255, 0.9);
        }
        .subscription-card.frequency-year .date-info .billing {
            color: #dc3545;
        }
        .subscription-card.frequency-year .date-info .replenishment {
            color: #28a745;
        }
        /* Стили для отображения информации о подписке */
        .subscription-info {
            font-size: 0.7em;
            margin-top: 2px;
            text-align: center;
        }
        /* Специальные стили для subscription-info в зависимости от частоты */
        .subscription-card.frequency-month .subscription-info {
            color: rgba(255, 255, 255, 0.8);
        }
        .subscription-card.frequency-year .subscription-info {
            color: #666;
        }
        /* Стили для кнопок создания */
        .create-buttons {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        .create-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .create-subscription-btn {
            background: #007bff;
            color: white;
        }
        .create-subscription-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        .create-instance-btn {
            background: #28a745;
            color: white;
        }
        .create-instance-btn:hover {
            background: #1e7e34;
            transform: translateY(-2px);
        }
        .new-month-btn {
            background: #ffc107;
            color: #212529;
        }
        .new-month-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
<div class="layout">
    <div class="sidebar">
        <button class="sidebar-btn all active" id="filter-all" onclick="setFilter('all')">Все подписки</button>
        <button class="sidebar-btn to-pay" id="filter-to-pay" onclick="setFilter('to-pay')">К оплате</button>
        <button class="sidebar-btn completed" id="filter-completed" onclick="setFilter('completed')">Оплаченные</button>
        <button class="sidebar-btn archived" id="filter-archived" onclick="setFilter('archived')">Архив</button>
    </div>
    <div class="main-content">
        <h2 id="main-title">Все подписки</h2>
        
        <!-- Кнопки создания -->
        <div class="create-buttons" id="createButtons">
            <button class="create-btn create-subscription-btn" onclick="openCreateSubscriptionModal()">
                ➕ Создать подписку
            </button>
            <button class="create-btn create-instance-btn" onclick="openCreateInstanceModal()">
                📅 Создать экземпляр
            </button>
            <button class="create-btn new-month-btn" onclick="createNewMonthInstances()">
                🗓️ Новый месяц
            </button>
        </div>
        
        <!-- Фильтр по месяцам для оплаченных подписок -->
        <div class="month-filter" id="monthFilter">
            <h3>Выберите месяц для оплаченных подписок:</h3>
            <select id="monthSelect">
                <option value="">Все месяцы</option>
            </select>
            <button onclick="applyMonthFilter()">Применить</button>
        </div>
        
        <div class="cards-grid" id="subscriptionsList">
            <p>Загрузка...</p>
        </div>
    </div>
</div>
<!-- Модалка -->
<div class="modal-bg" id="modalBg">
    <div class="modal" id="modal">
        <span class="close" onclick="closeModal()">&times;</span>
        <div id="modalContent">
            <!-- Здесь будут детали подписки -->
        </div>
    </div>
</div>
<script>
// --- JS для фильтрации, карточек и модалки ---

let currentFilter = 'all';
let currentView = 'subscriptions'; // 'subscriptions' или 'instances'

// Сопоставление фильтра и параметров API
const filterMap = {
    'all': { endpoint: '/api/subscription' },
    'to-pay': { endpoint: '/api/subscription/instances/to-pay' },
    'completed': { endpoint: '/api/subscription/instances', params: { status: 'completed' } },
    'archived': { endpoint: '/api/subscription/archived' },
};

// Текущий выбранный месяц для фильтра
let selectedMonth = '';

// При загрузке страницы — показать все подписки
window.addEventListener('DOMContentLoaded', () => {
    setFilter('all');
});

function setFilter(type) {
    // Снимаем выделение со всех кнопок
    document.querySelectorAll('.sidebar-btn').forEach(btn => btn.classList.remove('active'));
    // Выделяем активную
    document.getElementById('filter-' + type).classList.add('active');
    
    // Показываем/скрываем фильтр по месяцам
    const monthFilter = document.getElementById('monthFilter');
    if (type === 'completed') {
        monthFilter.classList.add('active');
        populateMonthSelect();
    } else {
        monthFilter.classList.remove('active');
        selectedMonth = '';
    }
    
    // Показываем/скрываем кнопки создания
    const createButtons = document.getElementById('createButtons');
    if (type === 'all') {
        createButtons.style.display = 'flex';
    } else {
        createButtons.style.display = 'none';
    }
    
    // Меняем заголовок
    let title = 'Все подписки';
    if (type === 'to-pay') title = 'К оплате';
    if (type === 'completed') title = 'Оплаченные подписки';
    if (type === 'archived') title = 'Архив подписок';
    document.getElementById('main-title').textContent = title;
    
    // Определяем тип отображения
    currentView = (type === 'all' || type === 'archived') ? 'subscriptions' : 'instances';
    
    // Загружаем
    currentFilter = type;
    loadData(type);
}

async function loadData(type) {
    const filterConfig = filterMap[type];
    if (!filterConfig) return;
    
    let params = filterConfig.params ? { ...filterConfig.params } : {};
    
    // Добавляем фильтр по месяцу, если выбран
    if (selectedMonth) {
        params.month = selectedMonth;
    }
    
    let url = filterConfig.endpoint;
    if (Object.keys(params).length > 0) {
        url += '?' + new URLSearchParams(params).toString();
    }
    
    try {
        const response = await fetch(url);
        const data = await response.json();
        
        if (currentView === 'subscriptions') {
            displaySubscriptions(data.subscriptions || []);
        } else {
            displayInstances(data.instances || []);
        }
    } catch (e) {
        document.getElementById('subscriptionsList').innerHTML = '<p>Ошибка загрузки</p>';
    }
}

function displaySubscriptions(subscriptions) {
    const list = document.getElementById('subscriptionsList');
    if (!subscriptions.length) {
        list.innerHTML = '<p>Нет подписок</p>';
        return;
    }
    list.innerHTML = subscriptions.map(sub => `
        <div class="subscription-card status-other frequency-${sub.frequency}" onclick="openSubscriptionModal(${sub.id})">
            <svg class="icon" viewBox="0 0 48 48"><rect x="8" y="12" width="32" height="28" rx="4" fill="none" stroke="#b6c6e3" stroke-width="3"/><rect x="16" y="4" width="16" height="8" rx="2" fill="#fff" stroke="#b6c6e3" stroke-width="3"/></svg>
            <div class="name">${sub.name}</div>
            <div class="amount">${formatAmount(sub.amount)}</div>
            <div class="subscription-info">Шаблон подписки (${sub.frequency === 'month' ? 'месячная' : 'годовая'})</div>
            <div class="date-info">
                <div class="billing">💳 ${formatDateTime(sub.billing_time)}</div>
                <div class="replenishment">💰 ${formatDateTime(sub.replenishment_time)}</div>
            </div>
        </div>
    `).join('');
}

function displayInstances(instances) {
    const list = document.getElementById('subscriptionsList');
    if (!instances.length) {
        list.innerHTML = '<p>Нет экземпляров подписок</p>';
        return;
    }
    list.innerHTML = instances.map(instance => `
        <div class="subscription-card status-${instance.status || 'other'}" onclick="openInstanceModal(${instance.id})">
            ${instance.status === 'progress' ? `<button class='card-ready-btn' onclick='event.stopPropagation(); markReady(${instance.id});' title='Готов к оплате'>💰</button>` : ''}
            ${instance.status !== 'completed' ? `<button class='card-check-btn' onclick='event.stopPropagation(); markCompleted(${instance.id});' title='Отметить как оплачено'>✔</button>` : ''}
            <svg class="icon" viewBox="0 0 48 48"><rect x="8" y="12" width="32" height="28" rx="4" fill="none" stroke="#b6c6e3" stroke-width="3"/><rect x="16" y="4" width="16" height="8" rx="2" fill="#fff" stroke="#b6c6e3" stroke-width="3"/></svg>
            <div class="name">${instance.subscription ? instance.subscription.name : 'Неизвестная подписка'}</div>
            <div class="amount">${formatAmount(instance.amount)}</div>
            <div class="subscription-info">Экземпляр подписки</div>
            <div class="date-info">
                <div class="billing">💳 ${formatDateTime(instance.billing_time)}</div>
                <div class="replenishment">💰 ${formatDateTime(instance.replenishment_time)}</div>
            </div>
        </div>
    `).join('');
}

function formatAmount(amount) {
    return new Intl.NumberFormat('ru-RU', {
        style: 'currency', currency: 'RUB', minimumFractionDigits: 0
    }).format(amount / 100);
}

function formatDateTime(dateTimeStr) {
    if (!dateTimeStr) return 'Не указано';
    const date = new Date(dateTimeStr);
    return date.toLocaleDateString('ru-RU', { 
        day: '2-digit', 
        month: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Функция для заполнения селекта месяцев
function populateMonthSelect() {
    const monthSelect = document.getElementById('monthSelect');
    const currentDate = new Date();
    const currentYear = currentDate.getFullYear();
    const currentMonth = currentDate.getMonth();
    
    // Очищаем селект, оставляя только "Все месяцы"
    monthSelect.innerHTML = '<option value="">Все месяцы</option>';
    
    // Добавляем месяцы за последние 2 года
    const monthNames = [
        "Январь", "Февраль", "Март", "Апрель", "Май", "Июнь",
        "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"
    ];
    
    for (let year = currentYear - 1; year <= currentYear + 1; year++) {
        for (let month = 0; month < 12; month++) {
            const monthStr = String(month + 1).padStart(2, '0');
            const yearMonth = `${year}-${monthStr}`;
            const option = document.createElement('option');
            option.value = yearMonth;
            option.textContent = `${monthNames[month]} ${year}`;
            monthSelect.appendChild(option);
        }
    }
    
    // Устанавливаем текущий месяц как выбранный по умолчанию
    const currentYearMonth = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
    monthSelect.value = currentYearMonth;
    selectedMonth = currentYearMonth;
}

// Функция для применения фильтра по месяцу
function applyMonthFilter() {
    const monthSelect = document.getElementById('monthSelect');
    selectedMonth = monthSelect.value;
    loadData(currentFilter);
}

// --- Модалка для подписок ---
let currentSubscription = null;
let isEditing = false;

async function openSubscriptionModal(id) {
    // Загружаем детали подписки
    try {
        const response = await fetch(`/api/subscription/${id}`);
        const data = await response.json();
        if (data.subscription) {
            currentSubscription = data.subscription;
            showSubscriptionModalContent(data.subscription);
        } else {
            showSubscriptionModalContent({ name: 'Ошибка', amount: 0 });
        }
    } catch (e) {
        showSubscriptionModalContent({ name: 'Ошибка', amount: 0 });
    }
    document.getElementById('modalBg').classList.add('active');
}

async function openInstanceModal(id) {
    // Загружаем детали экземпляра подписки
    try {
        const response = await fetch(`/api/subscription/instances/${id}`);
        const data = await response.json();
        if (data.instance) {
            currentSubscription = data.instance;
            showInstanceModalContent(data.instance);
        } else {
            showInstanceModalContent({ subscription: { name: 'Ошибка' }, amount: 0 });
        }
    } catch (e) {
        showInstanceModalContent({ subscription: { name: 'Ошибка' }, amount: 0 });
    }
    document.getElementById('modalBg').classList.add('active');
}

function closeModal() {
    document.getElementById('modalBg').classList.remove('active');
    isEditing = false;
    currentSubscription = null;
}

function showSubscriptionModalContent(sub) {
    // Подготавливаем значения для input datetime-local
    const billingTime = sub.billing_time ? sub.billing_time.slice(0, 16) : '';
    const replenishmentTime = sub.replenishment_time ? sub.replenishment_time.slice(0, 16) : '';
    
    document.getElementById('modalContent').innerHTML = `
        <h2>${sub.name}</h2>
        
        <div class="modal-field">
            <label>Название:</label>
            <input type="text" id="edit-name" value="${sub.name}" ${!isEditing ? 'readonly class="readonly"' : ''}>
        </div>
        
        <div class="modal-field">
            <label>Сумма (в копейках):</label>
            <input type="number" id="edit-amount" value="${sub.amount}" ${!isEditing ? 'readonly class="readonly"' : ''}>
        </div>
        
        <div class="modal-field">
            <label>Частота:</label>
            <select id="edit-frequency" ${!isEditing ? 'disabled' : ''}>
                <option value="month" ${sub.frequency === 'month' ? 'selected' : ''}>Месячная</option>
                <option value="year" ${sub.frequency === 'year' ? 'selected' : ''}>Годовая</option>
            </select>
        </div>
        
        <div class="modal-field">
            <label>Дата и время списания:</label>
            <input type="datetime-local" id="edit-billing-time" value="${billingTime}" ${!isEditing ? 'readonly class="readonly"' : ''}>
        </div>
        
        <div class="modal-field">
            <label>Дата и время пополнения:</label>
            <input type="datetime-local" id="edit-replenishment-time" value="${replenishmentTime}" ${!isEditing ? 'readonly class="readonly"' : ''}>
        </div>
        
        <div class="modal-field">
            <label>Источник:</label>
            <input type="text" id="edit-source" value="${sub.source || ''}" ${!isEditing ? 'readonly class="readonly"' : ''}>
        </div>
        
        <div class="modal-field">
            <label>Создано:</label>
            <input type="text" value="${sub.created_at ? new Date(sub.created_at).toLocaleString('ru-RU') : ''}" readonly class="readonly">
        </div>
        
        <div class="modal-field">
            <label>Обновлено:</label>
            <input type="text" value="${sub.updated_at ? new Date(sub.updated_at).toLocaleString('ru-RU') : ''}" readonly class="readonly">
        </div>
        
        <div class="modal-actions">
            ${isEditing ? `
                <button class="btn btn-success" onclick="saveSubscriptionChanges()">Сохранить</button>
                <button class="btn btn-secondary" onclick="cancelEdit()">Отмена</button>
            ` : `
                <button class="btn btn-primary" onclick="startEdit()">Редактировать</button>
                ${sub.archived_at ? `
                    <button class="btn btn-warning" onclick="unarchiveSubscription()">Разархивировать</button>
                ` : `
                    <button class="btn btn-warning" onclick="archiveSubscription()">Архивировать</button>
                `}
                <button class="btn btn-danger" onclick="deleteSubscription()">Удалить</button>
            `}
        </div>
    `;
}

function showInstanceModalContent(instance) {
    // Подготавливаем значения для input datetime-local
    const billingTime = instance.billing_time ? instance.billing_time.slice(0, 16) : '';
    const replenishmentTime = instance.replenishment_time ? instance.replenishment_time.slice(0, 16) : '';
    
    document.getElementById('modalContent').innerHTML = `
        <h2>${instance.subscription ? instance.subscription.name : 'Неизвестная подписка'}</h2>
        
        <div class="modal-field">
            <label>Название подписки:</label>
            <input type="text" value="${instance.subscription ? instance.subscription.name : 'Неизвестная подписка'}" readonly class="readonly">
        </div>
        
        <div class="modal-field">
            <label>Сумма (в копейках):</label>
            <input type="number" id="edit-amount" value="${instance.amount}" ${!isEditing ? 'readonly class="readonly"' : ''}>
        </div>
        
        <div class="modal-field">
            <label>Статус:</label>
            <select id="edit-status" ${!isEditing ? 'disabled' : ''}>
                <option value="progress" ${instance.status === 'progress' ? 'selected' : ''}>Активная (ожидает пополнения)</option>
                <option value="ready" ${instance.status === 'ready' ? 'selected' : ''}>Готов к оплате (деньги есть, ждет времени)</option>
                <option value="completed" ${instance.status === 'completed' ? 'selected' : ''}>Оплачена</option>
            </select>
        </div>
        
        <div class="modal-field">
            <label>Дата и время списания:</label>
            <input type="datetime-local" id="edit-billing-time" value="${billingTime}" ${!isEditing ? 'readonly class="readonly"' : ''}>
        </div>
        
        <div class="modal-field">
            <label>Дата и время пополнения:</label>
            <input type="datetime-local" id="edit-replenishment-time" value="${replenishmentTime}" ${!isEditing ? 'readonly class="readonly"' : ''}>
        </div>
        
        <div class="modal-field">
            <label>Дата завершения:</label>
            <input type="text" value="${instance.completed_at ? new Date(instance.completed_at).toLocaleString('ru-RU') : 'Не завершена'}" readonly class="readonly">
        </div>
        
        <div class="modal-field">
            <label>Создано:</label>
            <input type="text" value="${instance.created_at ? new Date(instance.created_at).toLocaleString('ru-RU') : ''}" readonly class="readonly">
        </div>
        
        <div class="modal-field">
            <label>Обновлено:</label>
            <input type="text" value="${instance.updated_at ? new Date(instance.updated_at).toLocaleString('ru-RU') : ''}" readonly class="readonly">
        </div>
        
        <div class="modal-actions">
            ${isEditing ? `
                <button class="btn btn-success" onclick="saveInstanceChanges()">Сохранить</button>
                <button class="btn btn-secondary" onclick="cancelEdit()">Отмена</button>
            ` : `
                <button class="btn btn-primary" onclick="startEdit()">Редактировать</button>
                <button class="btn btn-danger" onclick="deleteInstance()">Удалить</button>
            `}
        </div>
    `;
}

function startEdit() {
    isEditing = true;
    if (currentView === 'subscriptions') {
        showSubscriptionModalContent(currentSubscription);
    } else {
        showInstanceModalContent(currentSubscription);
    }
}

function cancelEdit() {
    isEditing = false;
    if (currentView === 'subscriptions') {
        showSubscriptionModalContent(currentSubscription);
    } else {
        showInstanceModalContent(currentSubscription);
    }
}

async function saveSubscriptionChanges() {
    if (!currentSubscription) return;
    
    const updatedData = {
        name: document.getElementById('edit-name').value,
        amount: parseInt(document.getElementById('edit-amount').value),
        frequency: document.getElementById('edit-frequency').value,
        billing_time: document.getElementById('edit-billing-time').value,
        replenishment_time: document.getElementById('edit-replenishment-time').value,
        source: document.getElementById('edit-source').value
    };
    
    try {
        const response = await fetch(`/api/subscription/${currentSubscription.id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updatedData)
        });
        
        const result = await response.json();
        if (result.success) {
            // Обновляем текущую подписку
            currentSubscription = { ...currentSubscription, ...updatedData };
            isEditing = false;
            showSubscriptionModalContent(currentSubscription);
            
            // Обновляем список подписок
            loadData(currentFilter);
            
            alert('Подписка успешно обновлена!');
        } else {
            alert('Ошибка при обновлении: ' + (result.error || 'Неизвестная ошибка'));
        }
    } catch (e) {
        alert('Ошибка при сохранении изменений');
    }
}

async function saveInstanceChanges() {
    if (!currentSubscription) return;
    
    const updatedData = {
        amount: parseInt(document.getElementById('edit-amount').value),
        status: document.getElementById('edit-status').value,
        billing_time: document.getElementById('edit-billing-time').value,
        replenishment_time: document.getElementById('edit-replenishment-time').value
    };
    
    try {
        const response = await fetch(`/api/subscription/instances/${currentSubscription.id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updatedData)
        });
        
        const result = await response.json();
        if (result.success) {
            // Обновляем текущий экземпляр
            currentSubscription = { ...currentSubscription, ...updatedData };
            isEditing = false;
            showInstanceModalContent(currentSubscription);
            
            // Обновляем список экземпляров
            loadData(currentFilter);
            
            alert('Экземпляр подписки успешно обновлен!');
        } else {
            alert('Ошибка при обновлении: ' + (result.error || 'Неизвестная ошибка'));
        }
    } catch (e) {
        alert('Ошибка при сохранении изменений');
    }
}

async function archiveSubscription() {
    if (!currentSubscription || !confirm('Вы уверены, что хотите архивировать эту подписку?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/subscription/${currentSubscription.id}/archive`, {
            method: 'POST'
        });
        
        const result = await response.json();
        if (result.success) {
            closeModal();
            loadData(currentFilter);
            alert('Подписка успешно архивирована!');
        } else {
            alert('Ошибка при архивации: ' + (result.error || 'Неизвестная ошибка'));
        }
    } catch (e) {
        alert('Ошибка при архивации подписки');
    }
}

async function unarchiveSubscription() {
    if (!currentSubscription || !confirm('Вы уверены, что хотите разархивировать эту подписку?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/subscription/${currentSubscription.id}/unarchive`, {
            method: 'POST'
        });
        
        const result = await response.json();
        if (result.success) {
            closeModal();
            loadData(currentFilter);
            alert('Подписка успешно разархивирована!');
        } else {
            alert('Ошибка при разархивации: ' + (result.error || 'Неизвестная ошибка'));
        }
    } catch (e) {
        alert('Ошибка при разархивации подписки');
    }
}

async function deleteSubscription() {
    if (!currentSubscription || !confirm('Вы уверены, что хотите удалить эту подписку?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/subscription/${currentSubscription.id}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (response.ok && result.message) {
            closeModal();
            loadData(currentFilter);
            alert('Подписка успешно удалена!');
        } else {
            // Показываем более подробную ошибку
            const errorMessage = result.error || 'Неизвестная ошибка';
            alert('Ошибка при удалении: ' + errorMessage);
        }
    } catch (e) {
        alert('Ошибка при удалении подписки: ' + e.message);
    }
}

async function deleteInstance() {
    if (!currentSubscription || !confirm('Вы уверены, что хотите удалить этот экземпляр подписки?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/subscription/instances/${currentSubscription.id}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (response.ok && result.message) {
            closeModal();
            loadData(currentFilter);
            alert('Экземпляр подписки успешно удален!');
        } else {
            // Показываем более подробную ошибку
            const errorMessage = result.error || 'Неизвестная ошибка';
            alert('Ошибка при удалении: ' + errorMessage);
        }
    } catch (e) {
        alert('Ошибка при удалении экземпляра подписки: ' + e.message);
    }
}

async function markCompleted(id) {
    try {
        const response = await fetch(`/api/subscription/instances/${id}/complete`, {
            method: 'POST'
        });
        const result = await response.json();
        if (result.message) {
            loadData(currentFilter);
        } else {
            alert('Ошибка при обновлении статуса');
        }
    } catch (e) {
        alert('Ошибка при обновлении статуса');
    }
}

async function markReady(id) {
    try {
        const response = await fetch(`/api/subscription/instances/${id}/ready`, {
            method: 'POST'
        });
        const result = await response.json();
        if (result.message) {
            loadData(currentFilter);
        } else {
            alert('Ошибка при обновлении статуса');
        }
    } catch (e) {
        alert('Ошибка при обновлении статуса');
    }
}

// Функции для создания подписок и экземпляров
async function openCreateSubscriptionModal() {
    const modalContent = document.getElementById('modalContent');
    modalContent.innerHTML = `
        <h3>Создать новую подписку</h3>
        <div class="modal-field">
            <label for="create-name">Название подписки:</label>
            <input type="text" id="create-name" placeholder="Например: Netflix Premium">
        </div>
        <div class="modal-field">
            <label for="create-amount">Сумма (в копейках):</label>
            <input type="number" id="create-amount" placeholder="150000">
        </div>
        <div class="modal-field">
            <label for="create-billing-time">Время списания:</label>
            <input type="time" id="create-billing-time" value="10:00">
        </div>
        <div class="modal-field">
            <label for="create-replenishment-time">Время пополнения:</label>
            <input type="time" id="create-replenishment-time" value="10:00">
        </div>
        <div class="modal-field">
            <label for="create-frequency">Частота:</label>
            <select id="create-frequency">
                <option value="month">Месячная</option>
                <option value="year">Годовая</option>
            </select>
        </div>
        <div class="modal-field">
            <label for="create-source">Источник оплаты:</label>
            <input type="text" id="create-source" placeholder="Например: Банковская карта">
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeModal()">Отмена</button>
            <button class="btn btn-primary" onclick="createSubscription()">Создать</button>
        </div>
    `;
    document.getElementById('modalBg').classList.add('active');
}

async function createSubscription() {
    const subscriptionData = {
        name: document.getElementById('create-name').value,
        amount: parseInt(document.getElementById('create-amount').value),
        billing_time: document.getElementById('create-billing-time').value,
        replenishment_time: document.getElementById('create-replenishment-time').value,
        frequency: document.getElementById('create-frequency').value,
        source: document.getElementById('create-source').value
    };
    
    // Валидация
    if (!subscriptionData.name || !subscriptionData.amount || !subscriptionData.source) {
        alert('Пожалуйста, заполните все обязательные поля');
        return;
    }
    
    try {
        const response = await fetch('/api/subscription', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(subscriptionData)
        });
        
        const result = await response.json();
        if (result.success) {
            closeModal();
            loadData(currentFilter);
            alert('Подписка успешно создана!');
        } else {
            alert('Ошибка при создании: ' + (result.error || 'Неизвестная ошибка'));
        }
    } catch (e) {
        alert('Ошибка при создании подписки');
    }
}

async function openCreateInstanceModal() {
    // Сначала загружаем список подписок для выбора
    try {
        const response = await fetch('/api/subscription');
        const data = await response.json();
        const subscriptions = data.subscriptions || [];
        
        if (subscriptions.length === 0) {
            alert('Сначала создайте хотя бы одну подписку');
            return;
        }
        
        const modalContent = document.getElementById('modalContent');
        modalContent.innerHTML = `
            <h3>Создать экземпляр подписки</h3>
            <div class="modal-field">
                <label for="create-instance-subscription">Выберите подписку:</label>
                <select id="create-instance-subscription">
                    ${subscriptions.map(sub => `<option value="${sub.id}">${sub.name} (${sub.frequency === 'month' ? 'месячная' : 'годовая'})</option>`).join('')}
                </select>
            </div>
            <div class="modal-field">
                <label for="create-instance-amount">Сумма (в копейках):</label>
                <input type="number" id="create-instance-amount" placeholder="150000">
            </div>
            <div class="modal-field">
                <label for="create-instance-billing-time">Дата и время списания:</label>
                <input type="datetime-local" id="create-instance-billing-time">
            </div>
            <div class="modal-field">
                <label for="create-instance-replenishment-time">Дата и время пополнения:</label>
                <input type="datetime-local" id="create-instance-replenishment-time">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Отмена</button>
                <button class="btn btn-primary" onclick="createInstance()">Создать</button>
            </div>
        `;
        
        // Устанавливаем текущую дату и время по умолчанию
        const now = new Date();
        const nowStr = now.toISOString().slice(0, 16);
        document.getElementById('create-instance-billing-time').value = nowStr;
        document.getElementById('create-instance-replenishment-time').value = nowStr;
        
        document.getElementById('modalBg').classList.add('active');
    } catch (e) {
        alert('Ошибка при загрузке списка подписок');
    }
}

async function createInstance() {
    const instanceData = {
        subscription_id: parseInt(document.getElementById('create-instance-subscription').value),
        amount: parseInt(document.getElementById('create-instance-amount').value),
        billing_time: document.getElementById('create-instance-billing-time').value,
        replenishment_time: document.getElementById('create-instance-replenishment-time').value,
        status: 'progress'  // Всегда создаем в статусе progress
    };
    
    // Валидация
    if (!instanceData.subscription_id || !instanceData.amount) {
        alert('Пожалуйста, заполните все обязательные поля');
        return;
    }
    
    try {
        const response = await fetch('/api/subscription/instances', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(instanceData)
        });
        
        const result = await response.json();
        if (result.success) {
            closeModal();
            loadData(currentFilter);
            alert('Экземпляр подписки успешно создан!');
        } else {
            alert('Ошибка при создании: ' + (result.error || 'Неизвестная ошибка'));
        }
    } catch (e) {
        alert('Ошибка при создании экземпляра подписки');
    }
}

async function createNewMonthInstances() {
    if (!confirm('Создать экземпляры подписок для текущего месяца? Это действие нельзя отменить.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/subscription/new-month', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        if (result.success) {
            // Формируем детальное сообщение
            let message = result.message + '\n\n';
            message += `✅ Создано: ${result.created_count} экземпляров\n`;
            message += `⏭️ Пропущено: ${result.skipped_count} подписок\n\n`;
            
            if (result.created_instances.length > 0) {
                message += '📋 Созданные экземпляры:\n';
                result.created_instances.forEach(instance => {
                    const amount = (instance.amount / 100).toFixed(2);
                    const date = new Date(instance.billing_time).toLocaleDateString('ru-RU');
                    message += `  • ${instance.subscription_name} - ${amount}₽ (${date})\n`;
                });
            }
            
            if (result.skipped_subscriptions.length > 0) {
                message += '\n⏭️ Пропущенные подписки:\n';
                result.skipped_subscriptions.forEach(sub => {
                    message += `  • ${sub.subscription_name} - ${sub.reason}\n`;
                });
            }
            
            alert(message);
            loadData(currentFilter);
        } else {
            alert('Ошибка при создании экземпляров: ' + (result.error || 'Неизвестная ошибка'));
        }
    } catch (e) {
        alert('Ошибка при создании экземпляров нового месяца');
    }
}
</script>
</body>
</html> 