<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–¥–ø–∏—Å–∫–∏ ‚Äî –∫–∞—Ä—Ç–æ—Ç–µ–∫–∞</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
        }
        .layout {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 120px;
            background: #e3eafc;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            padding: 20px 0;
            border-right: 2px solid #b6c6e3;
        }
        .sidebar-btn {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            margin: 10px 0;
            padding: 12px 8px;
            border: none;
            border-radius: 8px 8px 0 0;
            background: #fff;
            color: #333;
            font-weight: bold;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .sidebar-btn.active, .sidebar-btn:hover {
            background: #b6c6e3;
            color: #007bff;
        }
        .main-content {
            flex: 1;
            background: #d6f0ff;
            padding: 30px 40px;
            display: flex;
            flex-direction: column;
        }
        .main-content h2 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 30px;
        }
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 30px;
            justify-items: center;
        }
        .subscription-card {
            width: 160px;
            height: 200px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 3px solid #000;
            transition: border 0.2s, box-shadow 0.2s, background 0.2s;
            position: relative;
        }
        .subscription-card.status-progress {
            background: #fffbe6;
            border-color: #ffc107;
        }
        .subscription-card.status-ready {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        .subscription-card.status-completed {
            background: #e6ffed;
            border-color: #28a745;
        }
        .subscription-card.status-other {
            background: #f5f5f5;
            border-color: #b6c6e3;
        }
        .subscription-card.frequency-month {
            background: #007bff;
            color: white;
        }
        .subscription-card.frequency-year {
            background: #e6e6fa;
            color: #333;
        }
        .subscription-card .icon {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–∫–æ–Ω–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —á–∞—Å—Ç–æ—Ç—ã */
        .subscription-card.frequency-month .icon {
            filter: brightness(0) invert(1);
        }
        .subscription-card.frequency-year .icon {
            filter: none;
        }
        .subscription-card .name {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 8px;
            text-align: center;
        }
        .subscription-card .amount {
            font-size: 1.2em;
            font-weight: bold;
        }
        /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —á–∞—Å—Ç–æ—Ç—ã */
        .subscription-card.frequency-month .name,
        .subscription-card.frequency-month .amount {
            color: white;
        }
        .subscription-card.frequency-year .name,
        .subscription-card.frequency-year .amount {
            color: #333;
        }
        /* –ú–æ–¥–∞–ª–∫–∞ */
        .modal-bg {
            display: none;
            position: fixed;
            left: 0; top: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-bg.active {
            display: flex;
        }
        .modal {
            background: #fff;
            border-radius: 12px;
            padding: 30px 30px 20px 30px;
            min-width: 320px;
            max-width: 90vw;
            box-shadow: 0 4px 24px rgba(0,0,0,0.18);
            position: relative;
        }
        .modal .close {
            position: absolute;
            right: 18px;
            top: 12px;
            font-size: 1.5em;
            color: #888;
            cursor: pointer;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
        .modal-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .modal-field {
            margin-bottom: 15px;
        }
        .modal-field label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        .modal-field input, .modal-field select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .modal-field input:focus, .modal-field select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        .readonly {
            background: #f8f9fa;
            color: #6c757d;
        }
        /* –¶–≤–µ—Ç–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤ —Å–∞–π–¥–±–∞—Ä–µ */
        .sidebar-btn.all { background: #e3eafc; color: #333; }
        .sidebar-btn.to-pay { background: #fffde7; color: #ff9800; }
        .sidebar-btn.completed { background: #e6ffed; color: #28a745; }
        .sidebar-btn.archived { background: #f5f5f5; color: #6c757d; }
        .sidebar-btn.active {
            border-left: 6px solid #007bff;
            filter: brightness(0.95);
        }
        .card-check-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #e6ffed;
            border: 2px solid #28a745;
            color: #28a745;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 1.2em;
            cursor: pointer;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .card-check-btn:hover {
            background: #28a745;
            color: #fff;
        }
        .card-ready-btn {
            position: absolute;
            top: 8px;
            right: 40px;
            background: #e3f2fd;
            border: 2px solid #2196f3;
            color: #2196f3;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 1.2em;
            cursor: pointer;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .card-ready-btn:hover {
            background: #2196f3;
            color: #fff;
        }
        .subscription-card.status-completed .card-check-btn,
        .subscription-card.status-completed .card-ready-btn {
            display: none;
        }
        .subscription-card.status-ready .card-ready-btn {
            display: none;
        }
        .subscription-card {
            position: relative;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –º–µ—Å—è—Ü–∞–º */
        .month-filter {
            margin: 20px 0;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }
        .month-filter.active {
            display: block;
        }
        .month-filter h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.1em;
        }
        .month-filter select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-right: 10px;
        }
        .month-filter button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .month-filter button:hover {
            background: #0056b3;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞—Ç */
        .date-info {
            font-size: 0.8em;
            color: #666;
            margin-top: 4px;
            text-align: center;
        }
        .date-info .billing {
            color: #dc3545;
        }
        .date-info .replenishment {
            color: #28a745;
        }
        /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è date-info –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —á–∞—Å—Ç–æ—Ç—ã */
        .subscription-card.frequency-month .date-info .billing {
            color: rgba(255, 255, 255, 0.9);
        }
        .subscription-card.frequency-month .date-info .replenishment {
            color: rgba(255, 255, 255, 0.9);
        }
        .subscription-card.frequency-year .date-info .billing {
            color: #dc3545;
        }
        .subscription-card.frequency-year .date-info .replenishment {
            color: #28a745;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–¥–ø–∏—Å–∫–µ */
        .subscription-info {
            font-size: 0.7em;
            margin-top: 2px;
            text-align: center;
        }
        /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è subscription-info –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —á–∞—Å—Ç–æ—Ç—ã */
        .subscription-card.frequency-month .subscription-info {
            color: rgba(255, 255, 255, 0.8);
        }
        .subscription-card.frequency-year .subscription-info {
            color: #666;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Å–æ–∑–¥–∞–Ω–∏—è */
        .create-buttons {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        .create-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .create-subscription-btn {
            background: #007bff;
            color: white;
        }
        .create-subscription-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        .create-instance-btn {
            background: #28a745;
            color: white;
        }
        .create-instance-btn:hover {
            background: #1e7e34;
            transform: translateY(-2px);
        }
        .new-month-btn {
            background: #ffc107;
            color: #212529;
        }
        .new-month-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
<div class="layout">
    <div class="sidebar">
        <button class="sidebar-btn all active" id="filter-all" onclick="setFilter('all')">–í—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏</button>
        <button class="sidebar-btn to-pay" id="filter-to-pay" onclick="setFilter('to-pay')">–ö –æ–ø–ª–∞—Ç–µ</button>
        <button class="sidebar-btn completed" id="filter-completed" onclick="setFilter('completed')">–û–ø–ª–∞—á–µ–Ω–Ω—ã–µ</button>
        <button class="sidebar-btn archived" id="filter-archived" onclick="setFilter('archived')">–ê—Ä—Ö–∏–≤</button>
    </div>
    <div class="main-content">
        <h2 id="main-title">–í—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏</h2>
        
        <!-- –ö–Ω–æ–ø–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è -->
        <div class="create-buttons" id="createButtons">
            <button class="create-btn create-subscription-btn" onclick="openCreateSubscriptionModal()">
                ‚ûï –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
            </button>
            <button class="create-btn create-instance-btn" onclick="openCreateInstanceModal()">
                üìÖ –°–æ–∑–¥–∞—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä
            </button>
            <button class="create-btn new-month-btn" onclick="createNewMonthInstances()">
                üóìÔ∏è –ù–æ–≤—ã–π –º–µ—Å—è—Ü
            </button>
        </div>
        
        <!-- –§–∏–ª—å—Ç—Ä –ø–æ –º–µ—Å—è—Ü–∞–º –¥–ª—è –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫ -->
        <div class="month-filter" id="monthFilter">
            <h3>–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü –¥–ª—è –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫:</h3>
            <select id="monthSelect">
                <option value="">–í—Å–µ –º–µ—Å—è—Ü—ã</option>
            </select>
            <button onclick="applyMonthFilter()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
        
        <div class="cards-grid" id="subscriptionsList">
            <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
    </div>
</div>
<!-- –ú–æ–¥–∞–ª–∫–∞ -->
<div class="modal-bg" id="modalBg">
    <div class="modal" id="modal">
        <span class="close" onclick="closeModal()">&times;</span>
        <div id="modalContent">
            <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –¥–µ—Ç–∞–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∏ -->
        </div>
    </div>
</div>
<script>
// --- JS –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏, –∫–∞—Ä—Ç–æ—á–µ–∫ –∏ –º–æ–¥–∞–ª–∫–∏ ---

let currentFilter = 'all';
let currentView = 'subscriptions'; // 'subscriptions' –∏–ª–∏ 'instances'

// –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ API
const filterMap = {
    'all': { endpoint: '/api/subscription' },
    'to-pay': { endpoint: '/api/subscription/instances/to-pay' },
    'completed': { endpoint: '/api/subscription/instances', params: { status: 'completed' } },
    'archived': { endpoint: '/api/subscription/archived' },
};

// –¢–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞
let selectedMonth = '';

// –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏
window.addEventListener('DOMContentLoaded', () => {
    setFilter('all');
});

function setFilter(type) {
    // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
    document.querySelectorAll('.sidebar-btn').forEach(btn => btn.classList.remove('active'));
    // –í—ã–¥–µ–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é
    document.getElementById('filter-' + type).classList.add('active');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –º–µ—Å—è—Ü–∞–º
    const monthFilter = document.getElementById('monthFilter');
    if (type === 'completed') {
        monthFilter.classList.add('active');
        populateMonthSelect();
    } else {
        monthFilter.classList.remove('active');
        selectedMonth = '';
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è
    const createButtons = document.getElementById('createButtons');
    if (type === 'all') {
        createButtons.style.display = 'flex';
    } else {
        createButtons.style.display = 'none';
    }
    
    // –ú–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
    let title = '–í—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏';
    if (type === 'to-pay') title = '–ö –æ–ø–ª–∞—Ç–µ';
    if (type === 'completed') title = '–û–ø–ª–∞—á–µ–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏';
    if (type === 'archived') title = '–ê—Ä—Ö–∏–≤ –ø–æ–¥–ø–∏—Å–æ–∫';
    document.getElementById('main-title').textContent = title;
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    currentView = (type === 'all' || type === 'archived') ? 'subscriptions' : 'instances';
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º
    currentFilter = type;
    loadData(type);
}

async function loadData(type) {
    const filterConfig = filterMap[type];
    if (!filterConfig) return;
    
    let params = filterConfig.params ? { ...filterConfig.params } : {};
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –º–µ—Å—è—Ü—É, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω
    if (selectedMonth) {
        params.month = selectedMonth;
    }
    
    let url = filterConfig.endpoint;
    if (Object.keys(params).length > 0) {
        url += '?' + new URLSearchParams(params).toString();
    }
    
    try {
        const response = await fetch(url);
        const data = await response.json();
        
        if (currentView === 'subscriptions') {
            displaySubscriptions(data.subscriptions || []);
        } else {
            displayInstances(data.instances || []);
        }
    } catch (e) {
        document.getElementById('subscriptionsList').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
    }
}

function displaySubscriptions(subscriptions) {
    const list = document.getElementById('subscriptionsList');
    if (!subscriptions.length) {
        list.innerHTML = '<p>–ù–µ—Ç –ø–æ–¥–ø–∏—Å–æ–∫</p>';
        return;
    }
    list.innerHTML = subscriptions.map(sub => `
        <div class="subscription-card status-other frequency-${sub.frequency}" onclick="openSubscriptionModal(${sub.id})">
            <svg class="icon" viewBox="0 0 48 48"><rect x="8" y="12" width="32" height="28" rx="4" fill="none" stroke="#b6c6e3" stroke-width="3"/><rect x="16" y="4" width="16" height="8" rx="2" fill="#fff" stroke="#b6c6e3" stroke-width="3"/></svg>
            <div class="name">${sub.name}</div>
            <div class="amount">${formatAmount(sub.amount)}</div>
            <div class="subscription-info">–®–∞–±–ª–æ–Ω –ø–æ–¥–ø–∏—Å–∫–∏ (${sub.frequency === 'month' ? '–º–µ—Å—è—á–Ω–∞—è' : '–≥–æ–¥–æ–≤–∞—è'})</div>
            <div class="date-info">
                <div class="billing">üí≥ ${formatDateTime(sub.billing_time)}</div>
                <div class="replenishment">üí∞ ${formatDateTime(sub.replenishment_time)}</div>
            </div>
        </div>
    `).join('');
}

function displayInstances(instances) {
    const list = document.getElementById('subscriptionsList');
    if (!instances.length) {
        list.innerHTML = '<p>–ù–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –ø–æ–¥–ø–∏—Å–æ–∫</p>';
        return;
    }
    list.innerHTML = instances.map(instance => `
        <div class="subscription-card status-${instance.status || 'other'}" onclick="openInstanceModal(${instance.id})">
            ${instance.status === 'progress' ? `<button class='card-ready-btn' onclick='event.stopPropagation(); markReady(${instance.id});' title='–ì–æ—Ç–æ–≤ –∫ –æ–ø–ª–∞—Ç–µ'>üí∞</button>` : ''}
            ${instance.status !== 'completed' ? `<button class='card-check-btn' onclick='event.stopPropagation(); markCompleted(${instance.id});' title='–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–æ'>‚úî</button>` : ''}
            <svg class="icon" viewBox="0 0 48 48"><rect x="8" y="12" width="32" height="28" rx="4" fill="none" stroke="#b6c6e3" stroke-width="3"/><rect x="16" y="4" width="16" height="8" rx="2" fill="#fff" stroke="#b6c6e3" stroke-width="3"/></svg>
            <div class="name">${instance.subscription ? instance.subscription.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞'}</div>
            <div class="amount">${formatAmount(instance.amount)}</div>
            <div class="subscription-info">–≠–∫–∑–µ–º–ø–ª—è—Ä –ø–æ–¥–ø–∏—Å–∫–∏</div>
            <div class="date-info">
                <div class="billing">üí≥ ${formatDateTime(instance.billing_time)}</div>
                <div class="replenishment">üí∞ ${formatDateTime(instance.replenishment_time)}</div>
            </div>
        </div>
    `).join('');
}

function formatAmount(amount) {
    return new Intl.NumberFormat('ru-RU', {
        style: 'currency', currency: 'RUB', minimumFractionDigits: 0
    }).format(amount / 100);
}

function formatDateTime(dateTimeStr) {
    if (!dateTimeStr) return '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
    const date = new Date(dateTimeStr);
    return date.toLocaleDateString('ru-RU', { 
        day: '2-digit', 
        month: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Å–µ–ª–µ–∫—Ç–∞ –º–µ—Å—è—Ü–µ–≤
function populateMonthSelect() {
    const monthSelect = document.getElementById('monthSelect');
    const currentDate = new Date();
    const currentYear = currentDate.getFullYear();
    const currentMonth = currentDate.getMonth();
    
    // –û—á–∏—â–∞–µ–º —Å–µ–ª–µ–∫—Ç, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ "–í—Å–µ –º–µ—Å—è—Ü—ã"
    monthSelect.innerHTML = '<option value="">–í—Å–µ –º–µ—Å—è—Ü—ã</option>';
    
    // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Å—è—Ü—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –≥–æ–¥–∞
    const monthNames = [
        "–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å",
        "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"
    ];
    
    for (let year = currentYear - 1; year <= currentYear + 1; year++) {
        for (let month = 0; month < 12; month++) {
            const monthStr = String(month + 1).padStart(2, '0');
            const yearMonth = `${year}-${monthStr}`;
            const option = document.createElement('option');
            option.value = yearMonth;
            option.textContent = `${monthNames[month]} ${year}`;
            monthSelect.appendChild(option);
        }
    }
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü –∫–∞–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const currentYearMonth = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
    monthSelect.value = currentYearMonth;
    selectedMonth = currentYearMonth;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –º–µ—Å—è—Ü—É
function applyMonthFilter() {
    const monthSelect = document.getElementById('monthSelect');
    selectedMonth = monthSelect.value;
    loadData(currentFilter);
}

// --- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫ ---
let currentSubscription = null;
let isEditing = false;

async function openSubscriptionModal(id) {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∏
    try {
        const response = await fetch(`/api/subscription/${id}`);
        const data = await response.json();
        if (data.subscription) {
            currentSubscription = data.subscription;
            showSubscriptionModalContent(data.subscription);
        } else {
            showSubscriptionModalContent({ name: '–û—à–∏–±–∫–∞', amount: 0 });
        }
    } catch (e) {
        showSubscriptionModalContent({ name: '–û—à–∏–±–∫–∞', amount: 0 });
    }
    document.getElementById('modalBg').classList.add('active');
}

async function openInstanceModal(id) {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –ø–æ–¥–ø–∏—Å–∫–∏
    try {
        const response = await fetch(`/api/subscription/instances/${id}`);
        const data = await response.json();
        if (data.instance) {
            currentSubscription = data.instance;
            showInstanceModalContent(data.instance);
        } else {
            showInstanceModalContent({ subscription: { name: '–û—à–∏–±–∫–∞' }, amount: 0 });
        }
    } catch (e) {
        showInstanceModalContent({ subscription: { name: '–û—à–∏–±–∫–∞' }, amount: 0 });
    }
    document.getElementById('modalBg').classList.add('active');
}

function closeModal() {
    document.getElementById('modalBg').classList.remove('active');
    isEditing = false;
    currentSubscription = null;
}

function showSubscriptionModalContent(sub) {
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è input datetime-local
    const billingTime = sub.billing_time ? sub.billing_time.slice(0, 16) : '';
    const replenishmentTime = sub.replenishment_time ? sub.replenishment_time.slice(0, 16) : '';
    
    document.getElementById('modalContent').innerHTML = `
        <h2>${sub.name}</h2>
        
        <div class="modal-field">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
            <input type="text" id="edit-name" value="${sub.name}" ${!isEditing ? 'readonly class="readonly"' : ''}>
        </div>
        
        <div class="modal-field">
            <label>–°—É–º–º–∞ (–≤ –∫–æ–ø–µ–π–∫–∞—Ö):</label>
            <input type="number" id="edit-amount" value="${sub.amount}" ${!isEditing ? 'readonly class="readonly"' : ''}>
        </div>
        
        <div class="modal-field">
            <label>–ß–∞—Å—Ç–æ—Ç–∞:</label>
            <select id="edit-frequency" ${!isEditing ? 'disabled' : ''}>
                <option value="month" ${sub.frequency === 'month' ? 'selected' : ''}>–ú–µ—Å—è—á–Ω–∞—è</option>
                <option value="year" ${sub.frequency === 'year' ? 'selected' : ''}>–ì–æ–¥–æ–≤–∞—è</option>
            </select>
        </div>
        
        <div class="modal-field">
            <label>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è —Å–ø–∏—Å–∞–Ω–∏—è:</label>
            <input type="datetime-local" id="edit-billing-time" value="${billingTime}" ${!isEditing ? 'readonly class="readonly"' : ''}>
        </div>
        
        <div class="modal-field">
            <label>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è:</label>
            <input type="datetime-local" id="edit-replenishment-time" value="${replenishmentTime}" ${!isEditing ? 'readonly class="readonly"' : ''}>
        </div>
        
        <div class="modal-field">
            <label>–ò—Å—Ç–æ—á–Ω–∏–∫:</label>
            <input type="text" id="edit-source" value="${sub.source || ''}" ${!isEditing ? 'readonly class="readonly"' : ''}>
        </div>
        
        <div class="modal-field">
            <label>–°–æ–∑–¥–∞–Ω–æ:</label>
            <input type="text" value="${sub.created_at ? new Date(sub.created_at).toLocaleString('ru-RU') : ''}" readonly class="readonly">
        </div>
        
        <div class="modal-field">
            <label>–û–±–Ω–æ–≤–ª–µ–Ω–æ:</label>
            <input type="text" value="${sub.updated_at ? new Date(sub.updated_at).toLocaleString('ru-RU') : ''}" readonly class="readonly">
        </div>
        
        <div class="modal-actions">
            ${isEditing ? `
                <button class="btn btn-success" onclick="saveSubscriptionChanges()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="cancelEdit()">–û—Ç–º–µ–Ω–∞</button>
            ` : `
                <button class="btn btn-primary" onclick="startEdit()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                ${sub.archived_at ? `
                    <button class="btn btn-warning" onclick="unarchiveSubscription()">–†–∞–∑–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
                ` : `
                    <button class="btn btn-warning" onclick="archiveSubscription()">–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
                `}
                <button class="btn btn-danger" onclick="deleteSubscription()">–£–¥–∞–ª–∏—Ç—å</button>
            `}
        </div>
    `;
}

function showInstanceModalContent(instance) {
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è input datetime-local
    const billingTime = instance.billing_time ? instance.billing_time.slice(0, 16) : '';
    const replenishmentTime = instance.replenishment_time ? instance.replenishment_time.slice(0, 16) : '';
    
    document.getElementById('modalContent').innerHTML = `
        <h2>${instance.subscription ? instance.subscription.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞'}</h2>
        
        <div class="modal-field">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏:</label>
            <input type="text" value="${instance.subscription ? instance.subscription.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞'}" readonly class="readonly">
        </div>
        
        <div class="modal-field">
            <label>–°—É–º–º–∞ (–≤ –∫–æ–ø–µ–π–∫–∞—Ö):</label>
            <input type="number" id="edit-amount" value="${instance.amount}" ${!isEditing ? 'readonly class="readonly"' : ''}>
        </div>
        
        <div class="modal-field">
            <label>–°—Ç–∞—Ç—É—Å:</label>
            <select id="edit-status" ${!isEditing ? 'disabled' : ''}>
                <option value="progress" ${instance.status === 'progress' ? 'selected' : ''}>–ê–∫—Ç–∏–≤–Ω–∞—è (–æ–∂–∏–¥–∞–µ—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è)</option>
                <option value="ready" ${instance.status === 'ready' ? 'selected' : ''}>–ì–æ—Ç–æ–≤ –∫ –æ–ø–ª–∞—Ç–µ (–¥–µ–Ω—å–≥–∏ –µ—Å—Ç—å, –∂–¥–µ—Ç –≤—Ä–µ–º–µ–Ω–∏)</option>
                <option value="completed" ${instance.status === 'completed' ? 'selected' : ''}>–û–ø–ª–∞—á–µ–Ω–∞</option>
            </select>
        </div>
        
        <div class="modal-field">
            <label>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è —Å–ø–∏—Å–∞–Ω–∏—è:</label>
            <input type="datetime-local" id="edit-billing-time" value="${billingTime}" ${!isEditing ? 'readonly class="readonly"' : ''}>
        </div>
        
        <div class="modal-field">
            <label>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è:</label>
            <input type="datetime-local" id="edit-replenishment-time" value="${replenishmentTime}" ${!isEditing ? 'readonly class="readonly"' : ''}>
        </div>
        
        <div class="modal-field">
            <label>–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:</label>
            <input type="text" value="${instance.completed_at ? new Date(instance.completed_at).toLocaleString('ru-RU') : '–ù–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞'}" readonly class="readonly">
        </div>
        
        <div class="modal-field">
            <label>–°–æ–∑–¥–∞–Ω–æ:</label>
            <input type="text" value="${instance.created_at ? new Date(instance.created_at).toLocaleString('ru-RU') : ''}" readonly class="readonly">
        </div>
        
        <div class="modal-field">
            <label>–û–±–Ω–æ–≤–ª–µ–Ω–æ:</label>
            <input type="text" value="${instance.updated_at ? new Date(instance.updated_at).toLocaleString('ru-RU') : ''}" readonly class="readonly">
        </div>
        
        <div class="modal-actions">
            ${isEditing ? `
                <button class="btn btn-success" onclick="saveInstanceChanges()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="cancelEdit()">–û—Ç–º–µ–Ω–∞</button>
            ` : `
                <button class="btn btn-primary" onclick="startEdit()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn btn-danger" onclick="deleteInstance()">–£–¥–∞–ª–∏—Ç—å</button>
            `}
        </div>
    `;
}

function startEdit() {
    isEditing = true;
    if (currentView === 'subscriptions') {
        showSubscriptionModalContent(currentSubscription);
    } else {
        showInstanceModalContent(currentSubscription);
    }
}

function cancelEdit() {
    isEditing = false;
    if (currentView === 'subscriptions') {
        showSubscriptionModalContent(currentSubscription);
    } else {
        showInstanceModalContent(currentSubscription);
    }
}

async function saveSubscriptionChanges() {
    if (!currentSubscription) return;
    
    const updatedData = {
        name: document.getElementById('edit-name').value,
        amount: parseInt(document.getElementById('edit-amount').value),
        frequency: document.getElementById('edit-frequency').value,
        billing_time: document.getElementById('edit-billing-time').value,
        replenishment_time: document.getElementById('edit-replenishment-time').value,
        source: document.getElementById('edit-source').value
    };
    
    try {
        const response = await fetch(`/api/subscription/${currentSubscription.id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updatedData)
        });
        
        const result = await response.json();
        if (result.success) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–¥–ø–∏—Å–∫—É
            currentSubscription = { ...currentSubscription, ...updatedData };
            isEditing = false;
            showSubscriptionModalContent(currentSubscription);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–¥–ø–∏—Å–æ–∫
            loadData(currentFilter);
            
            alert('–ü–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π');
    }
}

async function saveInstanceChanges() {
    if (!currentSubscription) return;
    
    const updatedData = {
        amount: parseInt(document.getElementById('edit-amount').value),
        status: document.getElementById('edit-status').value,
        billing_time: document.getElementById('edit-billing-time').value,
        replenishment_time: document.getElementById('edit-replenishment-time').value
    };
    
    try {
        const response = await fetch(`/api/subscription/instances/${currentSubscription.id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updatedData)
        });
        
        const result = await response.json();
        if (result.success) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —ç–∫–∑–µ–º–ø–ª—è—Ä
            currentSubscription = { ...currentSubscription, ...updatedData };
            isEditing = false;
            showInstanceModalContent(currentSubscription);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤
            loadData(currentFilter);
            
            alert('–≠–∫–∑–µ–º–ø–ª—è—Ä –ø–æ–¥–ø–∏—Å–∫–∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π');
    }
}

async function archiveSubscription() {
    if (!currentSubscription || !confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å —ç—Ç—É –ø–æ–¥–ø–∏—Å–∫—É?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/subscription/${currentSubscription.id}/archive`, {
            method: 'POST'
        });
        
        const result = await response.json();
        if (result.success) {
            closeModal();
            loadData(currentFilter);
            alert('–ü–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!');
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏');
    }
}

async function unarchiveSubscription() {
    if (!currentSubscription || !confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Ä–∞–∑–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å —ç—Ç—É –ø–æ–¥–ø–∏—Å–∫—É?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/subscription/${currentSubscription.id}/unarchive`, {
            method: 'POST'
        });
        
        const result = await response.json();
        if (result.success) {
            closeModal();
            loadData(currentFilter);
            alert('–ü–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!');
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–∞—Ä—Ö–∏–≤–∞—Ü–∏–∏: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏');
    }
}

async function deleteSubscription() {
    if (!currentSubscription || !confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø–æ–¥–ø–∏—Å–∫—É?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/subscription/${currentSubscription.id}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (response.ok && result.message) {
            closeModal();
            loadData(currentFilter);
            alert('–ü–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!');
        } else {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω—É—é –æ—à–∏–±–∫—É
            const errorMessage = result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + errorMessage);
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏: ' + e.message);
    }
}

async function deleteInstance() {
    if (!currentSubscription || !confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä –ø–æ–¥–ø–∏—Å–∫–∏?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/subscription/instances/${currentSubscription.id}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (response.ok && result.message) {
            closeModal();
            loadData(currentFilter);
            alert('–≠–∫–∑–µ–º–ø–ª—è—Ä –ø–æ–¥–ø–∏—Å–∫–∏ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!');
        } else {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω—É—é –æ—à–∏–±–∫—É
            const errorMessage = result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + errorMessage);
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –ø–æ–¥–ø–∏—Å–∫–∏: ' + e.message);
    }
}

async function markCompleted(id) {
    try {
        const response = await fetch(`/api/subscription/instances/${id}/complete`, {
            method: 'POST'
        });
        const result = await response.json();
        if (result.message) {
            loadData(currentFilter);
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
    }
}

async function markReady(id) {
    try {
        const response = await fetch(`/api/subscription/instances/${id}/ready`, {
            method: 'POST'
        });
        const result = await response.json();
        if (result.message) {
            loadData(currentFilter);
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
    }
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫ –∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤
async function openCreateSubscriptionModal() {
    const modalContent = document.getElementById('modalContent');
    modalContent.innerHTML = `
        <h3>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É</h3>
        <div class="modal-field">
            <label for="create-name">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏:</label>
            <input type="text" id="create-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Netflix Premium">
        </div>
        <div class="modal-field">
            <label for="create-amount">–°—É–º–º–∞ (–≤ –∫–æ–ø–µ–π–∫–∞—Ö):</label>
            <input type="number" id="create-amount" placeholder="150000">
        </div>
        <div class="modal-field">
            <label for="create-billing-time">–í—Ä–µ–º—è —Å–ø–∏—Å–∞–Ω–∏—è:</label>
            <input type="time" id="create-billing-time" value="10:00">
        </div>
        <div class="modal-field">
            <label for="create-replenishment-time">–í—Ä–µ–º—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è:</label>
            <input type="time" id="create-replenishment-time" value="10:00">
        </div>
        <div class="modal-field">
            <label for="create-frequency">–ß–∞—Å—Ç–æ—Ç–∞:</label>
            <select id="create-frequency">
                <option value="month">–ú–µ—Å—è—á–Ω–∞—è</option>
                <option value="year">–ì–æ–¥–æ–≤–∞—è</option>
            </select>
        </div>
        <div class="modal-field">
            <label for="create-source">–ò—Å—Ç–æ—á–Ω–∏–∫ –æ–ø–ª–∞—Ç—ã:</label>
            <input type="text" id="create-source" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞">
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" onclick="createSubscription()">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    `;
    document.getElementById('modalBg').classList.add('active');
}

async function createSubscription() {
    const subscriptionData = {
        name: document.getElementById('create-name').value,
        amount: parseInt(document.getElementById('create-amount').value),
        billing_time: document.getElementById('create-billing-time').value,
        replenishment_time: document.getElementById('create-replenishment-time').value,
        frequency: document.getElementById('create-frequency').value,
        source: document.getElementById('create-source').value
    };
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!subscriptionData.name || !subscriptionData.amount || !subscriptionData.source) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
        return;
    }
    
    try {
        const response = await fetch('/api/subscription', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(subscriptionData)
        });
        
        const result = await response.json();
        if (result.success) {
            closeModal();
            loadData(currentFilter);
            alert('–ü–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!');
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏');
    }
}

async function openCreateInstanceModal() {
    // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–¥–ø–∏—Å–æ–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞
    try {
        const response = await fetch('/api/subscription');
        const data = await response.json();
        const subscriptions = data.subscriptions || [];
        
        if (subscriptions.length === 0) {
            alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø–æ–¥–ø–∏—Å–∫—É');
            return;
        }
        
        const modalContent = document.getElementById('modalContent');
        modalContent.innerHTML = `
            <h3>–°–æ–∑–¥–∞—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä –ø–æ–¥–ø–∏—Å–∫–∏</h3>
            <div class="modal-field">
                <label for="create-instance-subscription">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É:</label>
                <select id="create-instance-subscription">
                    ${subscriptions.map(sub => `<option value="${sub.id}">${sub.name} (${sub.frequency === 'month' ? '–º–µ—Å—è—á–Ω–∞—è' : '–≥–æ–¥–æ–≤–∞—è'})</option>`).join('')}
                </select>
            </div>
            <div class="modal-field">
                <label for="create-instance-amount">–°—É–º–º–∞ (–≤ –∫–æ–ø–µ–π–∫–∞—Ö):</label>
                <input type="number" id="create-instance-amount" placeholder="150000">
            </div>
            <div class="modal-field">
                <label for="create-instance-billing-time">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è —Å–ø–∏—Å–∞–Ω–∏—è:</label>
                <input type="datetime-local" id="create-instance-billing-time">
            </div>
            <div class="modal-field">
                <label for="create-instance-replenishment-time">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è:</label>
                <input type="datetime-local" id="create-instance-replenishment-time">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="createInstance()">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        `;
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const now = new Date();
        const nowStr = now.toISOString().slice(0, 16);
        document.getElementById('create-instance-billing-time').value = nowStr;
        document.getElementById('create-instance-replenishment-time').value = nowStr;
        
        document.getElementById('modalBg').classList.add('active');
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫');
    }
}

async function createInstance() {
    const instanceData = {
        subscription_id: parseInt(document.getElementById('create-instance-subscription').value),
        amount: parseInt(document.getElementById('create-instance-amount').value),
        billing_time: document.getElementById('create-instance-billing-time').value,
        replenishment_time: document.getElementById('create-instance-replenishment-time').value,
        status: 'progress'  // –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–µ–º –≤ —Å—Ç–∞—Ç—É—Å–µ progress
    };
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!instanceData.subscription_id || !instanceData.amount) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
        return;
    }
    
    try {
        const response = await fetch('/api/subscription/instances', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(instanceData)
        });
        
        const result = await response.json();
        if (result.success) {
            closeModal();
            loadData(currentFilter);
            alert('–≠–∫–∑–µ–º–ø–ª—è—Ä –ø–æ–¥–ø–∏—Å–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –ø–æ–¥–ø–∏—Å–∫–∏');
    }
}

async function createNewMonthInstances() {
    if (!confirm('–°–æ–∑–¥–∞—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –ø–æ–¥–ø–∏—Å–æ–∫ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/subscription/new-month', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        if (result.success) {
            // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            let message = result.message + '\n\n';
            message += `‚úÖ –°–æ–∑–¥–∞–Ω–æ: ${result.created_count} —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤\n`;
            message += `‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ: ${result.skipped_count} –ø–æ–¥–ø–∏—Å–æ–∫\n\n`;
            
            if (result.created_instances.length > 0) {
                message += 'üìã –°–æ–∑–¥–∞–Ω–Ω—ã–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã:\n';
                result.created_instances.forEach(instance => {
                    const amount = (instance.amount / 100).toFixed(2);
                    const date = new Date(instance.billing_time).toLocaleDateString('ru-RU');
                    message += `  ‚Ä¢ ${instance.subscription_name} - ${amount}‚ÇΩ (${date})\n`;
                });
            }
            
            if (result.skipped_subscriptions.length > 0) {
                message += '\n‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏:\n';
                result.skipped_subscriptions.forEach(sub => {
                    message += `  ‚Ä¢ ${sub.subscription_name} - ${sub.reason}\n`;
                });
            }
            
            alert(message);
            loadData(currentFilter);
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –Ω–æ–≤–æ–≥–æ –º–µ—Å—è—Ü–∞');
    }
}
</script>
</body>
</html> 